<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meet in the Middle - Interactive Map</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div class="header">
        <h1>🗺️ Meet in the Middle</h1>
        <p>Interactive map with heat zones and travel routes</p>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <div id="status" class="status-indicator"></div>
            
            <form id="searchForm">
                <div class="input-group">
                    <label for="address1">📍 First Address <span id="locationStatus" style="font-size: 12px; color: #666;"></span></label>
                    <input type="text" id="address1" placeholder="Detecting your location..." required>
                </div>
                
                <div class="input-group">
                    <label for="address2">📍 Second Address</label>
                    <input type="text" id="address2" placeholder="Start typing for suggestions..." required>
                </div>
                
                <button type="submit" class="search-btn" id="searchBtn">
                    🚇 Find Meeting Point
                </button>
            </form>
            
            <div class="business-filters" id="businessFilters" style="display: none;">
                <h4>🏪 Business Filters</h4>
                <div class="filter-group">
                    <label class="filter-checkbox">
                        <input type="checkbox" value="restaurant" checked> 🍽️ Restaurants
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="cafe" checked> ☕ Cafes
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="bar" checked> 🍺 Bars
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="shopping_mall" checked> 🛍️ Shopping
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="store" checked> 🏪 Stores
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="park" checked> 🌳 Parks
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="tourist_attraction" checked> 🎯 Attractions
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="gym" checked> 💪 Gyms
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="library" checked> 📚 Libraries
                    </label>
                </div>
                <button class="filter-apply-btn" onclick="applyFilters()">Apply Filters</button>
                <div class="business-count" style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;">
                    No businesses displayed
                </div>
            </div>
            
            <div id="loading" class="loading" style="display: none;">
                🔍 Finding optimal meeting point and calculating routes...
            </div>
            
            <div id="results"></div>
        </div>
        
        <div class="map-container">
            <div class="maps-container single-map" id="mapsContainer">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap: detect API base, load app and Google Maps -->
    <script>
        (function bootstrap() {
            // Try same-origin first; API server sets CORS for browser use
            const defaultCandidates = [
                // Same-origin relative (works when served behind a proxy)
                '/api/config',
                // Common local dev ports
                'http://localhost:5001/api/config',
                'http://127.0.0.1:5001/api/config',
                'http://localhost:5000/api/config',
                'http://127.0.0.1:5000/api/config'
            ];

            async function discoverConfig(urls) {
                for (const url of urls) {
                    try {
                        const resp = await fetch(url, { credentials: 'omit' });
                        if (resp && resp.ok) {
                            console.log('[Bootstrap] Config endpoint:', url);
                            return await resp.json();
                        } else {
                            console.warn('[Bootstrap] Config not OK at', url, resp && resp.status);
                        }
                    } catch (e) {
                        console.warn('[Bootstrap] Config fetch failed at', url, e && e.message);
                    }
                }
                throw new Error('All config endpoints failed');
            }

            discoverConfig(defaultCandidates)
                .then(config => {
                    if (!config || !config.success || !config.data) throw new Error('Bad config payload');
                    var base = (config.data.apiBaseUrl || '').replace(/\/$/, '');
                    if (base) {
                        window.API_BASE = base;
                    }
                    // Load main app script next so it can read window.API_BASE
                    var app = document.createElement('script');
                    app.src = 'scripts/main.js?v=13';
                    app.defer = true;
                    app.onload = function() {
                        if (window.setApiBase && window.API_BASE) {
                            window.setApiBase(window.API_BASE);
                        }
                    };
                    document.head.appendChild(app);

                    // Finally load Google Maps with the key
                    if (config.data.googleMapsApiKey) {
                        var gms = document.createElement('script');
                        gms.async = true;
                        gms.defer = true;
                        gms.src = 'https://maps.googleapis.com/maps/api/js?key=' +
                            encodeURIComponent(config.data.googleMapsApiKey) +
                            '&libraries=geometry,places&loading=async&v=weekly&callback=initMaps';
                        gms.onerror = function() {
                            console.error('Failed to load Google Maps API');
                            document.body.insertAdjacentHTML('beforeend', '<div style="position: fixed; top: 10px; right: 10px; background: #f44336; color: white; padding: 10px; border-radius: 4px;">❌ Google Maps API failed to load</div>');
                        };
                        document.head.appendChild(gms);
                    } else {
                        console.error('Google Maps API key not available');
                        document.body.insertAdjacentHTML('beforeend', '<div style="position: fixed; top: 10px; right: 10px; background: #ff9800; color: white; padding: 10px; border-radius: 4px;">⚠️ Google Maps API key not configured</div>');
                    }
                })
                .catch(err => {
                    console.error('Failed to get configuration:', err);
                    document.body.insertAdjacentHTML('beforeend', '<div style="position: fixed; top: 10px; right: 10px; background: #f44336; color: white; padding: 10px; border-radius: 4px;">❌ Failed to connect to API server</div>');
                });
        })();
    </script>
</body>
</html>
