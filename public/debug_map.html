<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meet in the Middle - Debug</title>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        #map { height: 400px; width: 100%; margin: 20px 0; border: 1px solid #ccc; }
        .form { margin: 20px 0; }
        input { padding: 10px; margin: 5px; width: 300px; }
        button { padding: 10px 20px; background: #007cba; color: white; border: none; cursor: pointer; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è Meet in the Middle - Debug Version</h1>
    <div id="status" class="status">Loading...</div>
    
    <div class="form">
        <input type="text" id="address1" placeholder="First address" value="Times Square, New York">
        <input type="text" id="address2" placeholder="Second address" value="Central Park, New York">
        <button onclick="findMiddlePoint()">Find Meeting Point</button>
    </div>
    
    <div id="map"></div>
    <div id="results"></div>

    <script>
        let map;
        let markers = [];
        
        function updateStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function initMaps() {
            console.log('üöÄ initMaps called');
            try {
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 12,
                    center: { lat: 40.7128, lng: -74.0060 }
                });
                
                // Test marker
                new google.maps.Marker({
                    position: { lat: 40.7128, lng: -74.0060 },
                    map: map,
                    title: 'Test - NYC'
                });
                
                updateStatus('‚úÖ Google Maps loaded successfully!');
                console.log('‚úÖ Map initialized');
            } catch (error) {
                console.error('‚ùå Map initialization error:', error);
                updateStatus('‚ùå Map failed to load: ' + error.message, 'error');
            }
        }
        
        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }
        
        async function findMiddlePoint() {
            const address1 = document.getElementById('address1').value;
            const address2 = document.getElementById('address2').value;
            
            if (!address1 || !address2) {
                updateStatus('‚ùå Please enter both addresses', 'error');
                return;
            }
            
            updateStatus('üîç Finding meeting point...');
            
            try {
                const response = await fetch('http://localhost:5000/api/find-middle-point', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address1: address1,
                        address2: address2,
                        search_radius: 2000
                    })
                });
                
                const result = await response.json();
                console.log('API Response:', result);
                
                if (result.success && result.data.optimal_meeting_point) {
                    displayResults(result.data);
                    updateStatus('‚úÖ Meeting point found!');
                } else {
                    updateStatus('‚ùå ' + (result.error || 'No meeting point found'), 'error');
                }
                
            } catch (error) {
                console.error('API Error:', error);
                updateStatus('‚ùå API Error: ' + error.message, 'error');
            }
        }
        
        function displayResults(data) {
            clearMarkers();
            
            const optimal = data.optimal_meeting_point;
            const address1 = data.address1.geocoded;
            const address2 = data.address2.geocoded;
            
            // Center map
            map.setCenter({ lat: optimal.lat, lng: optimal.lng });
            map.setZoom(14);
            
            // Add markers
            const marker1 = new google.maps.Marker({
                position: { lat: address1.lat, lng: address1.lng },
                map: map,
                title: 'Address 1',
                label: 'A'
            });
            
            const marker2 = new google.maps.Marker({
                position: { lat: address2.lat, lng: address2.lng },
                map: map,
                title: 'Address 2',
                label: 'B'
            });
            
            const optimalMarker = new google.maps.Marker({
                position: { lat: optimal.lat, lng: optimal.lng },
                map: map,
                title: optimal.name,
                label: '‚òÖ'
            });
            
            markers.push(marker1, marker2, optimalMarker);
            
            // Add walking circles
            const walkingSpeed = 80; // meters per minute
            [5, 10, 15].forEach((minutes, index) => {
                const colors = ['#4caf50', '#ffc107', '#f44336'];
                const circle = new google.maps.Circle({
                    strokeColor: colors[index],
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: colors[index],
                    fillOpacity: 0.15,
                    map: map,
                    center: { lat: optimal.lat, lng: optimal.lng },
                    radius: minutes * walkingSpeed
                });
                markers.push(circle);
            });
            
            document.getElementById('results').innerHTML = `
                <h3>üéØ ${optimal.name}</h3>
                <p>üìç ${optimal.formatted_address}</p>
                <p>üöá From A: ${Math.round(optimal.time_from_address1/60)} min</p>
                <p>üöá From B: ${Math.round(optimal.time_from_address2/60)} min</p>
                <p>‚öñÔ∏è Difference: ${optimal.time_difference_minutes} min</p>
            `;
        }
        
        // API status check
        fetch('http://localhost:5000/')
            .then(r => r.json())
            .then(data => console.log('‚úÖ API Status:', data))
            .catch(e => console.error('‚ùå API not available:', e));
            
    </script>
    
    <!-- Load Google Maps API dynamically -->
    <script>
        // Load Google Maps API with key from backend
        fetch('http://localhost:5001/api/config')
            .then(response => response.json())
            .then(config => {
                if (config.success && config.data.googleMapsApiKey) {
                    const script = document.createElement('script');
                    script.async = true;
                    script.defer = true;
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${config.data.googleMapsApiKey}&callback=initMaps`;
                    script.onerror = () => updateStatus('‚ùå Failed to load Google Maps API', 'error');
                    document.head.appendChild(script);
                } else {
                    updateStatus('‚ùå Google Maps API key not available', 'error');
                }
            })
            .catch(error => {
                updateStatus('‚ùå Failed to get configuration: ' + error.message, 'error');
            });
    </script>
</body>
</html>
